<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FourTwenty • The Player</title>
  <meta name="description" content="Decision simulation — branching paths, outcomes, and behavior under uncertainty." />
  <meta name="color-scheme" content="light dark" />

  <!-- Google Tag Manager (replace GTM ID if needed) -->
  <script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
    j.async=true; j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl; f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WVC4SNLB');
  </script>
  <!-- End GTM -->

  <!-- js-yaml for loading ./seeds/*.yml -->
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

  <script>
// --- RNG helper
function sampleOutcome(outcomes) {
  const r = Math.random();
  let cum = 0;
  for (const o of outcomes) { cum += Number(eval(String(o.p))); if (r <= cum) return o; }
  return outcomes[outcomes.length - 1];
}

// --- Bet policies
function betSize(policy, bankroll) {
  const kind = policy?.kind || 'fixed_fraction';
  if (kind === 'fixed_fraction') {
    const frac = Math.max(0, Math.min(1, Number(policy.fraction ?? 0.05)));
    const raw = bankroll * frac;
    return Math.max(Number(policy.min ?? 1), Math.floor(raw));
  }
  if (kind === 'fixed_amount') {
    return Math.max(1, Number(policy.amount ?? 1));
  }
  if (kind === 'kelly') {
    // Kelly for binary even-money with odds b: fraction f* = (b*p - (1-p))/b
    const p = Number(policy.p ?? 0.5);
    const b = Number(policy.b ?? 1); // net odds (even money = 1)
    const f = Math.max(0, (b*p - (1 - p)) / b);
    const cap = Number(policy.cap ?? 0.25);
    return Math.max(1, Math.floor(bankroll * Math.min(f, cap)));
  }
  return Math.max(1, Math.floor(bankroll * 0.05));
}

// --- One Monte Carlo run of a scenario
async function runScenario(sc, rounds, speedMs = 0) {
  const id = sc.id;
  let bankroll = Number(sc.bankroll?.start ?? 100);
  const goal = Number(sc.bankroll?.goal ?? Infinity);
  const floor = Number(sc.bankroll?.ruin_at ?? 0);
  const outcomes = sc.outcomes || [];
  const policy = sc.bet_policy || { kind: 'fixed_fraction', fraction: 0.05, min: 1 };

  Telemetry.setContext({ mode: 'sim', world_name: id });
  track('run_start', { scenario_id: id, bankroll });

  for (let r = 1; r <= rounds; r++) {
    const bet = Math.min(betSize(policy, bankroll), bankroll);
    if (bet <= 0) { emit('out_of_funds', { bankroll }); break; }

    emit('bet_placed', { round: r, bet, bankroll });

    const o = sampleOutcome(outcomes);
    const profit = bet * Number(o.multiplier);
    bankroll += profit;

    emit('round_complete', {
      round: r, outcome_id: o.id, multiplier: o.multiplier, bet, profit, bankroll
    });

    if (bankroll <= floor) { emit('ruin', { round: r, bankroll }); break; }
    if (bankroll >= goal) { emit('goal_hit', { round: r, bankroll }); break; }

    if (speedMs) await sleep(speedMs);
  }

  emit('run_complete', { scenario_id: id, final_bankroll: bankroll, total_reward: totalReward() });
  Telemetry.setContext({ mode: 'story' });
}

// --- UI hook: call this from a new button or reuse Reset/Export area
async function autoRunSelectedScenario() {
  const seeds = window.__SEEDS || {};
  const scenarios = seeds.scenarios || [];
  const sc = scenarios[0];                  // simplest: pick first scenario for now
  const rounds = Number(sc?.rounds ?? 100);
  await start();                            // reset page/log
  await runScenario(sc, rounds, 0);         // set last arg to e.g. 30ms to animate
}
</script>

  <style>
    :root{
      --bg:#0b0d10;--panel:#12161b;--muted:#7b8694;--fg:#eef2f6;--accent:#7dd3fc;--line:#1f2730;
    }
    @media (prefers-color-scheme: light){
      :root{--bg:#f7fafc;--panel:#ffffff;--muted:#5b6572;--fg:#0b1220;--accent:#0369a1;--line:#e6ebf1}
    }
    *{box-sizing:border-box}
    body{margin:0; font:14px/1.5 system-ui,-apple-system,Sego UI,Roboto,Arial; background:var(--bg); color:var(--fg)}
    header{display:flex;gap:.75rem;align-items:center; padding:18px 20px; border-bottom:1px solid var(--line); position:sticky; top:0; backdrop-filter:saturate(1.2) blur(6px); background:color-mix(in oklab, var(--bg) 92%, transparent)}
    header h1{font-size:18px; margin:0}
    header .badge{padding:2px 8px; border:1px solid var(--line); border-radius:999px; color:var(--muted)}

    .wrap{max-width:1100px; margin:0 auto; padding:20px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px}
    .card{background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:16px}
    .card h3{margin:.25rem 0 .75rem 0; font-size:16px}

    .story{min-height:270px}
    .story h2{margin:.1rem 0 .5rem 0; font-size:18px}
    .story p{margin:.25rem 0 .75rem 0}
    .choices{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .btn{appearance:none; border:1px solid var(--line); background:#1b2026; color:var(--fg); padding:8px 12px; border-radius:999px; cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}

    .controls label{display:flex; justify-content:space-between; align-items:center; margin:8px 0; color:var(--muted)}
    input[type="range"]{width:54%}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}

    .log{max-height:260px; overflow:auto; border-radius:12px; border:1px solid var(--line)}
    table{width:100%; border-collapse:collapse}
    th,td{padding:8px 10px; border-bottom:1px solid var(--line); font-size:12px}
    th{position:sticky; top:0; background:var(--panel)}

    footer{display:flex; gap:8px; justify-content:flex-end; margin-top:14px}
    a.link{color:var(--accent); text-decoration:none}
  </style>
</head>
<body>
  <!-- GTM noscript -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WVC4SNLB" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <header>
    <a href="https://zbreeden.github.io/FourTwentyAnalytics/?" class="btn" title="Back to FourTwenty">← Back</a>
    <h1>FourTwenty • The Player</h1>
    <span class="badge">v0.1</span>
    <span class="badge mono" id="run-id">—</span>
    <span style="margin-left:auto" class="badge">Story ▸ Sim ▸ Score</span>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- Story Mode -->
      <section class="card story" id="story">
        <h3>Story Mode</h3>
        <h2 id="story-title">Loading…</h2>
        <p id="story-text" style="white-space:pre-wrap"></p>
        <div class="choices" id="choices"></div>
        <div style="margin-top:8px; color:var(--muted)">
          <span class="mono">tick: <span id="tick">0</span></span>
          <span class="mono" style="margin-left:10px">supplies: <span id="supplies">—</span></span>
          <span class="mono" style="margin-left:10px">morale: <span id="morale">—</span></span>
        </div>
      </section>

      <!-- Sandbox / Controls -->
      <aside class="card">
        <h3>Sandbox</h3>
        <div class="controls">
          <label>Runs <input type="range" id="runs" min="1" max="2000" value="1000" step="1"> <span class="mono" id="runs-val">1000</span></label>
          <label>Event risk <input type="range" id="risk" min="0" max="100" value="35"> <span class="mono" id="risk-val">35</span></label>
          <label>WIP limit <input type="range" id="wip" min="1" max="10" value="5"> <span class="mono" id="wip-val">5</span></label>
        </div>
        <footer>
          <button class="btn" id="export">Export CSV</button>
          <button class="btn" onclick="autoRunSelectedScenario()">Auto-Run</button>
          <button class="btn" id="reset">Reset run</button>
        </footer>
      </aside>
    </div>

    <!-- Run Log Preview -->
    <section class="card" style="margin-top:16px">
      <h3>Recent events</h3>
      <div class="log">
        <table>
          <thead>
            <tr><th>tick</th><th>event</th><th>node</th><th>choice</th><th>reward</th></tr>
          </thead>
          <tbody id="log-body"></tbody>
        </table>
      </div>
      <div style="margin-top:8px; color:var(--muted)">
        Logs persist only for this session. Export to CSV to save under <span class="mono">/artifacts/logs/</span>.
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h3>Artifacts</h3>
      <p>• Power BI: <a class="link" href="./powerbi/PlayerScorecard.pbix" target="_blank" rel="noopener">PlayerScorecard.pbix</a>
         &nbsp;• Screens: <a class="link" href="./artifacts/screens/" target="_blank" rel="noopener">/artifacts/screens</a>
         &nbsp;• Logs: <a class="link" href="./artifacts/logs/" target="_blank" rel="noopener">/artifacts/logs</a></p>
    </section>
  </div>

  <script>
  // ─────────────────────────────────────────────────────────────
  // Telemetry (GTM/GA4)
  window.dataLayer = window.dataLayer || [];

  const Telemetry = (() => {
    let ctx = {
      src: 'player',           // easy GTM filter
      app: 'player-model',
      version: '0.1.1',        // bump when you ship
      session_id: crypto.randomUUID(),
      run_id: null,
      world_name: null,
      mode: 'story',           // or 'sim'
      branch: 'main'
    };

    function setContext(patch = {}) { ctx = { ...ctx, ...patch }; }

    function flatten(obj, prefix = '', out = {}) {
      if (!obj || typeof obj !== 'object') return out;
      for (const [k, v] of Object.entries(obj)) {
        const key = prefix ? `${prefix}.${k}` : k;
        if (v && typeof v === 'object' && !Array.isArray(v)) flatten(v, key, out);
        else out[key] = v;
      }
      return out;
    }

    function track(event, params = {}) {
      const payload = { ts: Date.now(), ...flatten(params) };
      const merged = { ...ctx, ...payload };
      try { window.dataLayer.push({ event, ...merged }); } catch (_) {}
      return merged;
    }

    return { track, setContext, getContext: () => ({ ...ctx }) };
  })();

  // keep old calls working
  const track = Telemetry.track;

  // Utils
  const uid = () => ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));
  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  // Very small CSV exporter
  function toCSV(rows){ if(!rows.length) return ""; const cols = Object.keys(rows[0]);
    const esc = v => '"'+String(v??"").replace(/"/g,'""')+'"';
    return [cols.join(','), ...rows.map(r=>cols.map(c=>esc(r[c])).join(','))].join('\n'); }
  function download(name, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/csv'})); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

  // State
  const state = { run_id: uid(), tick: 0, vars: { supplies: 100, morale: 50 }, node: null };
  const log = [];

  // Seed paths
  const SEEDS = ['world','actors','rules','storylets','parameters','scenarios'];

  async function loadSeeds(){
    const out = {};
    for(const f of SEEDS){
      try{
        const txt = await fetch(`./seeds/${f}.yml`).then(r=> r.ok ? r.text() : Promise.reject());
        out[f] = jsyaml.load(txt);
      }catch(e){
        // Fallback minimal seeds
        if(f==='world') out.world = { name:'CO₂ Triple System', variables:{ supplies:{start:100}, morale:{start:50} } };
        if(f==='storylets') out.storylets = [{ id:'canyon_entry', title:'The Canyon Mouth', text:'Chloe hums diagnostics. Wind tastes metallic. Descend or scout?', choices:[{id:'descend_canyon',label:'Descend (−10 supplies)', leads_to:'glyph_cache', effects:['supplies-=10'], reward:2}, {id:'scout_ridge',label:'Scout ridge (+2 morale)', leads_to:'ridge_scan', effects:['morale+=2'], reward:1}] }, { id:'glyph_cache', title:'Glyph Cache', text:'You brush dust from a rib of stone. The rings whisper.', choices:[{id:'end', label:'Log findings (finish)', reward:8}] }, { id:'ridge_scan', title:'Ridge Scan', text:'A broad view reveals safe paths.', choices:[{id:'end', label:'Mark route (finish)', reward:4}] }];
        if(f==='rules') out.rules = { updates: [] };
        if(f==='parameters') out.parameters = { runs:1000 };
      }
    }
    return out;
  }

  // Simple expression evaluator for effects like "supplies -= 10" or "morale += 2"
  function applyEffects(effects=[]) {
    const delta = {};
    for(const fx of effects){
      const m = String(fx).match(/^(\w+)\s*(\+=|-=|=)\s*(-?\d+(?:\.\d+)?)$/);
      if(!m) continue;
      const [, key, op, valStr] = m; const val = parseFloat(valStr);
      const cur = Number(state.vars[key] ?? 0);
      if(op==='=') state.vars[key] = val; else if(op==='+=' ) state.vars[key] = cur + val; else if(op==='-=') state.vars[key] = cur - val;
      delta[key] = state.vars[key];
    }
    emit('state_updated', { delta });
  }

  function emit(event,payload={}){
    const row = { ts:Date.now(), run_id: state.run_id, tick: state.tick, event, node_id: state.node?.id ?? null, choice_id: payload.choice_id ?? null, reward: payload.reward ?? null };
    log.push(row); track(event, row);
    renderLog();
  }

  function goTo(nodeId, seeds){
    const node = (seeds.storylets || []).find(n=>n.id===nodeId) || null;
    state.node = node; renderStory(node);
  }

  function renderStory(node){
    const title = document.getElementById('story-title');
    const text  = document.getElementById('story-text');
    const box   = document.getElementById('choices');
    title.textContent = node?.title ?? 'The End';
    text.textContent  = node?.text ?? 'Run complete.';
    box.innerHTML = '';

    if(!node){ emit('run_complete', { reward: totalReward() }); return; }

    (node.choices||[]).forEach(ch => {
      const btn = document.createElement('button'); btn.className='btn'; btn.textContent = ch.label || ch.id; btn.onclick = () => choose(ch);
      box.appendChild(btn);
    });

    document.getElementById('tick').textContent = String(state.tick);
    document.getElementById('supplies').textContent = String(state.vars.supplies);
    document.getElementById('morale').textContent = String(state.vars.morale);
  }

  function choose(ch){
    state.tick += 1;
    applyEffects(ch.effects);
    emit('choice_made', { choice_id: ch.id, reward: ch.reward ?? null });
    if(!ch.leads_to || ch.id==='end') { goTo(null, {}); return; }
    goTo(ch.leads_to, window.__SEEDS);
  }

  function totalReward(){ return log.reduce((s,r)=> s + (Number(r.reward)||0), 0); }

  function renderLog(){
    const body = document.getElementById('log-body'); body.innerHTML = '';
    const last = log.slice(-20);
    for(const r of last){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="mono">${r.tick}</td><td class="mono">${r.event}</td><td class="mono">${r.node_id??''}</td><td class="mono">${r.choice_id??''}</td><td class="mono">${r.reward??''}</td>`;
      body.appendChild(tr);
    }
  }

  function wireControls(){
    const runs = document.getElementById('runs');
    const risk = document.getElementById('risk');
    const wip  = document.getElementById('wip');
    runs.addEventListener('input', e=>{ document.getElementById('runs-val').textContent = e.target.value; track('sim_param_changed', {param:'runs', value:+e.target.value}); });
    risk.addEventListener('input', e=>{ document.getElementById('risk-val').textContent = e.target.value; track('sim_param_changed', {param:'event_risk', value:+e.target.value}); });
    wip .addEventListener('input', e=>{ document.getElementById('wip-val').textContent  = e.target.value; track('sim_param_changed', {param:'wip_limit', value:+e.target.value}); });

    document.getElementById('export').onclick = () => {
      const name = `player-run-${new Date().toISOString().replace(/[:.]/g,'-')}.csv`;
      download(name, toCSV(log));
      track('export_csv', { rows: log.length, name });
    };
    document.getElementById('reset').onclick = async () => { await start(); track('reset_run'); };
  }

  async function start(){
    state.run_id = uid(); state.tick = 0; log.length = 0; document.getElementById('run-id').textContent = state.run_id.slice(0,8);
    const seeds = await loadSeeds(); window.__SEEDS = seeds;
    // load initial vars from world
    try{
      const v = seeds.world?.variables || {}; state.vars.supplies = Number(v.supplies?.start ?? 100); state.vars.morale = Number(v.morale?.start ?? 50);
    }catch(_){}
    Telemetry.setContext({
      run_id: state.run_id,
      world_name: (window.__SEEDS?.world?.name) || 'Unknown',
      mode: 'story',
      branch: 'main',
      version: '0.1.1'
    });
    emit('run_start', {});
    goTo((seeds.storylets && seeds.storylets[0]?.id) || 'canyon_entry', seeds);
  }

  (async function init(){ wireControls(); await start(); })();
  </script>
</body>
</html>
